<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <style media="screen">
      body{
        font-size: 4vw;
      }
    </style>
  </head>
  <body>
    <h1 id="mainHeaderPanel">wlcome</h1>
    <p id="mainInfoPanel">Hello world</p>
    <p id="infoPanel">Hello world</p>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>


    <script type="text/javascript">
      console.log("Hello world")
let tg = window.Telegram.WebApp;




//g.initData //получаем данные от пользователя в виде строки (работает только при запуске из меню команд бота).
//tg.initDataUnsafe // получаем данные от пользователя в виде объекта (работает только при запуске из меню команд бота).
 // возвращает true, если приложение открыто на всю высоту, false - если нет.
console.log(tg.viewportHeight) // вернёт ширину окна.
//tg.sendData("Hello") // отправляет данные  боту в строковом виде, после чего закрывает приложение (работает только если приложение запущено с keyboard button).


window.addEventListener('load', (event) => {
  console.log('page is fully loaded');
  tg.expand()
  // tg.close() // метод закрывает приложение.

  tg.MainButton.text = 'Its Hack-time!' // текст кнопки, по умолчанию: "Continue"
  // tg.MainButton.color // цвет текста
  // tg.MainButton.textColor // цвет подложки
  // tg.MainButton.isVisible // видна ли кнопка (по умолчанию false)
  tg.MainButton.isActive // активна ли кнопка (по умолчанию true)

  tg.MainButton.onClick(testingMainButton) // метод при нажатии на кнопку
  tg.MainButton.enable() // сделать активной
  tg.MainButton.show() // показать кнопку
  // tg.MainButton.hide() // скрыть кнопку

  // tg.MainButton.disable() // сделать неактивной
  // tg.MainButton.setParams(params) // задает параметры в виде объекта

//  tg.expand()// метод позволяет растянуть окно на всю высоту.
});


var testingMainButton = () => {
  console.log("Oh yeahhh")
  document.getElementById("mainHeaderPanel").textContent = "big error"
  tg.MainButton.setText("Typing...") //  метод для задания текста

  setTimeout(() => {
    myTimer();
  }, "1000")

}


function myTimer() {
  console.log("Waited!")
  tg.MainButton.setText('Its Hack-time!') //  метод для задания текста

  chatboxModule.addTypewriter(document.getElementById("mainInfoPanel"), "Heawdawdllo this is tawdawdawdest", 200)
  chatboxModule.addTypewriter(document.getElementById("infoPanel"), "Hewdawdllo this iwdawdas tadwdawdest", 100)
}




class TypewritersMax {
    constructor() {
        this.typewritersArray = [];
        this.targetsArray = [];
    }
    addTypewriter(target, text, speed) {
      target.innerText = '';
      if(target.style.opacity == '' || target.style.opacity == '0'){
        target.style.opacity =  1;
      }
        let newtypewriter = new CommonTypewriter(speed, text)
        this.targetsArray.push(target);
        this.typewritersArray.push(newtypewriter);
        return true;
    }
    deleteTypewriter(target) {
      this.targetsArray.splice(target, 1);
      this.typewritersArray.splice(target, 1);
      return true;
    }
    executeTypingAcrossAllArrays(delta){
        if (this.targetsArray.length == 0) return;
        for (let t = 0; t < this.typewritersArray.length; t++) {
            let talkbox = this.typewritersArray[t]
            if (talkbox.type(delta)) {
                this.targetsArray[t].innerText = talkbox.currentText;
                if (talkbox.dead) {
                  this.deleteTypewriter(t)
                }
            }
        }
        return true;
    }
}

class CommonTypewriter {
    constructor(speed, final) {
        this.currentText = '';
        this.finalText = final;
        this.currentTimer = 200;
        this.speed = speed;
        this.dead = false;
    }
    addNextLetter() {
        //and check if writing is done
        if (this.currentText == this.finalText) {
            //console.log("Writing is done!")
            this.dead = true;
        } else {
            //adding one letter
            this.currentText = this.finalText.slice(0, this.currentText.length + 1)
        }
    }
    type(delta) {
        this.currentTimer -= delta;
        if (this.currentTimer < 0) {
            this.currentTimer = this.speed;
            //typing next letter now
            this.addNextLetter()
            return true;
        } else {
            return false;
        }
    }
}



const chatboxModule = new TypewritersMax()
let _timer = new Date().getTime();
let animate = () => {
    _delta = new Date().getTime() - _timer;
    _timer = new Date().getTime();
    //console.log("delta equal " + _delta)
    //TYPEWRITERS AND CHATS
    chatboxModule.executeTypingAcrossAllArrays(_delta)

    window.requestAnimationFrame(animate)
}
animate();
chatboxModule.addTypewriter(document.getElementById("mainHeaderPanel"), "Hello this is test", 100)

    </script>
  </body>
</html>
